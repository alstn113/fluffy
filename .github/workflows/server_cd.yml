name: Server CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'server/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/server

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    defaults:
      run:
        working-directory: server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build with Gradle
        run: ./gradlew clean bootJar

      - name: Check API docs in bootJar
        run: |
          JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "ğŸ” JAR íŒŒì¼ ê²½ë¡œ: $JAR_FILE"

          DOC_FILES=$(jar tf "$JAR_FILE" | grep 'BOOT-INF/classes/static/docs/')

          if [ -z "$DOC_FILES" ]; then
            echo "âŒ static/docs ê²½ë¡œì— í¬í•¨ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… JARì— í¬í•¨ëœ docs íŒŒì¼ ëª©ë¡:"
            echo "$DOC_FILES"
          fi

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          platforms: linux/amd64

  deploy:
    name: Deploy
    runs-on: [self-hosted]
    needs: build

    defaults:
      run:
        working-directory: ./server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Login to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env file
        env:
          SECRET_CONTEXT: ${{ toJson(secrets) }}
        run: |
          echo "$SECRET_CONTEXT" | tr -d '{}' | tr ',' '\n' | sed -n 's/"\(.*\)":\(.*\)/\1=\2/p' > .env

      - name: View
        run: cat .env

      - name: Compose Docker image and Update Nginx configuration
        env:
          DOCKER_APP_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          chmod +x ./scripts/deploy.sh # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          sudo -E ./scripts/deploy.sh # í™˜ê²½ ë³€ìˆ˜ ìœ ì§€ ë° ì‹¤í–‰

      - name: Docker remove unused images
        run: docker image prune -af

      - name: Check running containers
        run: docker ps -a
